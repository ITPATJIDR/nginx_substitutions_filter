server {
    listen 80;
    server_name localhost;

    # Enable gzip compression
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # Pass requests to Express app
    location / {
        # Remove auth headers from request
        proxy_set_header Authorization "";
        proxy_set_header X-API-Key "";
        proxy_set_header X-Auth-Token "";
        
        proxy_pass http://app:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Content-Type $content_type;

        # Advanced response transformations
        sub_filter '"name":' '"username":';
        sub_filter '"email":' '"email_address":';
        sub_filter '"phone":' '"phone_number":';
        sub_filter '"id":' '"user_id":';
        
        # Transform text in messages
        sub_filter 'name' 'username';
        sub_filter 'email' 'email_address';
        sub_filter 'phone' 'phone_number';
        sub_filter 'PAT' 'HI';
        
        sub_filter_once off;
        sub_filter_types *;

        proxy_hide_header Authorization;
    }

    # Health check endpoint
    location /health {
        proxy_pass http://app:3000/health;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}