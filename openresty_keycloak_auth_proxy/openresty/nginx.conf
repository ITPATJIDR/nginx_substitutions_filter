# nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /usr/local/openresty/nginx/logs/access.log  main;
    error_log   /usr/local/openresty/nginx/logs/error.log;

    sendfile        on;
    keepalive_timeout  65;

    # Include custom server configs
    include /etc/nginx/conf.d/*.conf;
}

# nginx/default.conf
server {
    listen 80;
    server_name localhost;

    # Health check endpoint (bypasses auth)
    location /health {
        access_by_lua_block {
            ngx.header.content_type = "application/json"
            ngx.say('{"status": "healthy", "service": "openresty"}')
            ngx.exit(200)
        }
    }

    # API routes with user info injection
    location /api/ {
        access_by_lua_block {
            -- Get user info from OAuth2-proxy headers
            local user = ngx.var.http_x_forwarded_user or "anonymous"
            local email = ngx.var.http_x_forwarded_email or ""
            local groups = ngx.var.http_x_forwarded_groups or ""
            
            -- Add user info to upstream request
            ngx.req.set_header("X-User", user)
            ngx.req.set_header("X-Email", email)
            ngx.req.set_header("X-Groups", groups)
        }
        
        proxy_pass http://express-api:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Default route
    location / {
        access_by_lua_block {
            ngx.header.content_type = "text/html"
            ngx.say('<h1>Welcome to Secured API Gateway</h1>')
            ngx.say('<p>API endpoints are available at <a href="/api/">/api/</a></p>')
            ngx.say('<p>Health check: <a href="/health">/health</a></p>')
            ngx.exit(200)
        }
    }
}